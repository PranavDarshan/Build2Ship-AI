on();

                if (data.success) {
                    closeFolderModal();
                    refreshFiles();
                    showToast('Folder created successfully', 'success');
                } else {
                    showToast('Error creating folder', 'error');
                }
            } catch (error) {
                console.error('Error creating folder:', error);
                showToast('Failed to create folder', 'error');
            }
        }

        // Terminal
        async function runTerminalCommand() {
            const input = document.getElementById('terminalInput');
            const command = input.value.trim();

            if (!command) return;

            const output = document.getElementById('terminalOutput');
            output.innerHTML += `<span class="terminal-prompt">$ </span>${escapeHtml(command)}\n`;
            input.value = '';

            try {
                const response = await fetch('/api/execute/bash', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({command})
                });

                const data = await response.json();

                if (data.stdout) output.textContent += data.stdout;
                if (data.stderr) output.innerHTML += `<span style="color: var(--error-red)">${escapeHtml(data.stderr)}</span>`;
                output.textContent += '\n';
                output.scrollTop = output.scrollHeight;
            } catch (error) {
                output.innerHTML += `<span style="color: var(--error-red)">Error: ${escapeHtml(error.message)}</span>\n\n`;
            }
        }

        function clearTerminal() {
            document.getElementById('terminalOutput').textContent = '';
        }

        // Tabs
        function switchTab(tab) {
            activeTab = tab;

            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('editorView').classList.toggle('hidden', tab !== 'editor');
            document.getElementById('terminalView').classList.toggle('hidden', tab !== 'terminal');
            document.getElementById('logsView').classList.toggle('hidden', tab !== 'logs');
        }

        function clearOutput() {
            document.getElementById('output').textContent = '';
        }

        // Logs
        function logExecution(file, success, time, output) {
            const log = {
                timestamp: new Date().toISOString(),
                file: file,
                success: success,
                executionTime: time,
                output: output
            };

            executionHistory.push(log);
            updateLogsView();
        }

        function updateLogsView() {
            const logsOutput = document.getElementById('logsOutput');

            if (executionHistory.length === 0) {
                logsOutput.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“‹</div>
                        <div class="empty-state-text">Execution logs will appear here</div>
                    </div>
                `;
                return;
            }

            logsOutput.innerHTML = executionHistory.map((log, i) => `
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-primary);">
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 6px;">
                        [${new Date(log.timestamp).toLocaleString()}] ${log.file}
                    </div>
                    <div style="color: ${log.success ? 'var(--success-green)' : 'var(--error-red)'}; margin-bottom: 4px;">
                        ${log.success ? 'âœ“ Success' : 'âœ— Failed'} â€¢ ${log.executionTime}ms
                    </div>
                    <div style="color: var(--text-tertiary); font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
                        ${escapeHtml(log.output || '(no output)')}
                    </div>
                </div>
            `).reverse().join('');
        }

        function clearLogs() {
            executionHistory = [];
            updateLogsView();
            showToast('Logs cleared', 'success');
        }

        function exportLogs() {
            const logs = JSON.stringify(executionHistory, null, 2);
            const blob = new Blob([logs], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `execution-logs-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Logs exported', 'success');
        }

        // Utilities
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeAttribute(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        // AI Assistant Functions
        function addAIMessage(role, content) {
            const aiMessages = document.getElementById('aiMessages');

            if (aiMessages.querySelector('.ai-empty-state')) {
                aiMessages.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${role}`;

            const bubble = document.createElement('div');
            bubble.className = 'ai-message-bubble';
            bubble.textContent = content;

            messageDiv.appendChild(bubble);
            aiMessages.appendChild(messageDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        function addAISystemMessage(content) {
            const aiMessages = document.getElementById('aiMessages');

            if (aiMessages.querySelector('.ai-empty-state')) {
                aiMessages.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message system';

            const bubble = document.createElement('div');
            bubble.className = 'ai-message-bubble';
            bubble.textContent = content;

            messageDiv.appendChild(bubble);
            aiMessages.appendChild(messageDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        function showAILoading() {
            const aiMessages = document.getElementById('aiMessages');

            if (aiMessages.querySelector('.ai-empty-state')) {
                aiMessages.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message assistant';
            messageDiv.id = 'aiLoadingMessage';

            const loading = document.createElement('div');
            loading.className = 'ai-loading';
            loading.innerHTML = '<div class="ai-loading-dot"></div><div class="ai-loading-dot"></div><div class="ai-loading-dot"></div>';

            messageDiv.appendChild(loading);
            aiMessages.appendChild(messageDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        function removeAILoading() {
            const loadingMsg = document.getElementById('aiLoadingMessage');
            if (loadingMsg) {
                loadingMsg.remove();
            }
        }

        async function sendAIMessage() {
            const aiInput = document.getElementById('aiInput');
            const message = aiInput.value.trim();

            if (!message || !currentContainer) return;

            // Add user message
            addAIMessage('user', message);
            aiInput.value = '';

            // Show loading
            showAILoading();

            try {
                const response = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message})
                });

                const data = await response.json();
                removeAILoading();

                if (data.success && data.response) {
                    // Parse and display response
                    const responseText = data.response.includes('[Executing:')
                        ? parseAIResponse(data.response)
                        : data.response;
                    addAIMessage('assistant', responseText);
                } else if (data.error) {
                    addAIMessage('assistant', `Error: ${data.error}`);
                } else {
                    addAIMessage('assistant', data.response || 'No response received');
                }
            } catch (error) {
                removeAILoading();
                console.error('Error sending AI message:', error);
                addAIMessage('assistant', `Connection error: ${error.message}`);
            }
        }

        function parseAIResponse(response) {
            // Clean up the response for display
            return response
                .replace(/\[Executing:/g, '\n[Executing:')
                .replace(/\[Success:/g, '\n[Success:')
                .replace(/\[Error:/g, '\n[Error:')
                .trim();
        }

        function clearAIChat() {
            const aiMessages = document.getElementById('aiMessages');
            aiMessages.innerHTML = `
                <div class="ai-empty-state">
                    <div class="ai-empty-state-icon">ðŸ¤–</div>
                    <div class="ai-empty-state-text">AI Assistant ready</div>
                    <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">Describe what you want to build</div>
                </div>
            `;
        }
    </script>
</body>
</html>
